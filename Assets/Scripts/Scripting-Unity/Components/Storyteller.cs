using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Search;

using MSW.Compiler;
using Object = UnityEngine.Object;
using MSW.Input;

namespace MSW.Unity
{
    public class Storyteller : MonoBehaviour
    {
        [Header("Run on Start")]
        [SerializeField] [SearchContext("ext:txt dir:Assets/Resources")] // QOL: Limit the files to ONLY project text files within Resources. 
        private TextAsset startupScript;
        
        [Header("Storyteller Commands")]
        [SerializeField] private MSWUnityLibrary[] libraries;
        [SerializeField] private GameObject choiceHandlerObject;
        private IChoiceHandler choiceHandler;

        private Dictionary<string, Descriptor> actors;
        
        private Compiler.Compiler compiler;
        
        private void Awake()
        {
            compiler = new Compiler.Compiler()
            {
                ErrorLogger = Logger,
                FunctionLibrary = libraries,
            };

            this.choiceHandler = choiceHandlerObject.GetComponent<IChoiceHandler>();
            
            this.SetupLibraries();
            this.SetupSceneObjects();
        }

        private void Start()
        {
            if(!startupScript)
            {
                return;
            }
            
            this.GetRunScript(startupScript.text, this.gameObject.name)?.Invoke();
        }

        private void OnDestroy()
        {
            this.CleanupOnFinish();
        }

        private void SetupLibraries()
        {
            foreach (var library in libraries)
            {
                library.GetObjectWithName = this.GetObjectWithName;
            }
        }

        private void SetupSceneObjects()
        {
            this.actors = new Dictionary<string, Descriptor>();
            
            var objects = Object.FindObjectsByType<Descriptor>(FindObjectsSortMode.None);
            foreach (var obj in objects)
            {
                this.actors[obj.ObjectName] = obj;
            }
            
            // Get all Action components within the scene.
            var actionComponents = Object.FindObjectsByType<Actions>(FindObjectsSortMode.None);
            foreach (var actionComponent in actionComponents)
            {
                if (actionComponent.ActionScript)
                {
                    this.GetRunScript(actionComponent.ActionScript.text, actionComponent.gameObject.name)?.Invoke();
                }
            }
        }

        #region ManuscriptWriter

        private Action GetRunScript(string script, string scriptName)
        {
            var manuscript = compiler.Compile(script);

            if (manuscript == null)
            {
                Debug.LogError($"Found an error in the actions for {scriptName} - check the previous messages in the console for more details!");
                return () => { };
            }

            var runner = new Runner(manuscript, this.choiceHandler)
            {
                Logger = Logger,
                OnFinish = CleanupOnFinish,
            };

            return () => this.RunScript(runner);
        }

        private void RunScript(Runner runner)
        {
            runner.Run();
        }
        
        private void CleanupOnFinish()
        {
            foreach (var library in this.libraries)
            {
                library.Cleanup();
            }
        }

        #endregion

        #region Utilities

        private Descriptor GetObjectWithName(string name)
        {
            return this.actors.GetValueOrDefault(name);
        }

        #endregion

        #region DEBUGGING
        
        private void Logger(string message)
        {
            Debug.LogError(message); 
        }

        #endregion
    }
}
